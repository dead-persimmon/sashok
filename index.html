<!doctype html>
<html lang='en' ng-app='_app'>
<head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <script src='http://ajax.googleapis.com/ajax/libs/angularjs/1.2.18/angular.min.js'></script>
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <title>ATL</title>
</head>
<body ng-controller='_controller'>
    <script>
        var _app = angular.module('_app', []);

        _app.controller('_controller', ['$scope', '$http', function ($scope, $http) {
        
            $scope.strings = {
                groupDisplayLimitHelp: 'Maximum number of groups to display in a single day.',
            };
            
            $scope.settings = {
                groupDisplayLimit: 10,

                sortField: 'downloads',
                sortReverse: true,

                displayNumSeeders: false,
                displayNumLeechers: false,
                displayNumDownloads: true,
            };
            
            $scope.daysPerRequest = 2;
            $scope.currentOffset = 0;
            
            $scope.days = [];
            
            ($scope.pullTorrents = function () {
                $http.get(['torrents?num_days=', $scope.daysPerRequest, '&offset=', $scope.currentOffset].join(''))
                    .success(function (data, status, headers, config) {
                        $scope.days = $scope.days.concat(data);
                        $scope.currentOffset += 1;
                    })
                    .error(function (data, status, headers, config) {
                        console.log('Request failed.');
                        console.log(arguments);
                    });
            })();
            
        }]);
    </script>

    <style>
        td a { color: #333; }
        td a:visited { color: #999; }
        tr.small { font-size: 75%; }
        .clickableGlyph { cursor: pointer; }
    </style>

    <hr>

    <div class='container-fluid'>
        <div class='row'>
            <div class='col-md-6' ng-repeat='day in days' ng-show='filteredDay.length > 0'>
                <div class='panel panel-default'>
                    <div class='panel-heading'>
                        Day &minus;{{$index}}
                            <em class='pull-right'>
                                Displaying {{filteredDay.length}} of {{day.length}} groups.
                                <a ng-show='filteredDay.length < day.length' ng-click='day.limit = day.length' href='#'>Show everything?</a>
                            </em>
                    </div>
                    <table class='table table-condensed'>
                        <thead>
                            <tr>
                                <th width='1%'>&nbsp;</th>
                                <th>Groups</th>
                                <th width='10%' class='text-right' ng-show='settings.displayNumSeeders'>&Sigma;S</th>
                                <th width='10%' class='text-right' ng-show='settings.displayNumLeechers'>&Sigma;L</th>
                                <th width='10%' class='text-right' ng-show='settings.displayNumDownloads'>&Sigma;D</th>
                            </tr>
                        </thead>
                        <tbody>
                                <tr
                                    ng-repeat-start='group in filteredDay = (day | orderBy:settings.sortField:settings.sortReverse | limitTo:(day.limit || settings.groupDisplayLimit))'
                                    ng-init='filteredTorrents = (group.torrents | orderBy:settings.sortField:settings.sortReverse)'
                                >
                                    <td>
                                        <span
                                            ng-click='group.expanded = !group.expanded'
                                            class='glyphicon glyphicon-{{ {true: "minus-sign", false: "plus-sign"}[!!group.expanded] }} clickableGlyph'>
                                        </span>
                                    </td>
                                    <td>
                                        <a href='{{filteredTorrents[0].link}}'>{{group.title}}<strong ng-show='group.episode'> Ep. {{group.episode}}</strong></a>
                                    </td>
                                    <td class='text-right' ng-show='settings.displayNumSeeders'>{{group.seeders | number}}</td>
                                    <td class='text-right' ng-show='settings.displayNumLeechers'>{{group.leechers | number}}</td>
                                    <td class='text-right' ng-show='settings.displayNumDownloads'>{{group.downloads | number}}</td>
                                </tr>
                                <tr class='small' ng-repeat-end ng-show='group.expanded' ng-repeat='torrent in filteredTorrents'>
                                    <td>&nbsp;</td>
                                    <td><a href='{{torrent.link}}'>{{torrent.title}}</a></td>
                                    <td class='text-right' ng-show='settings.displayNumSeeders'>{{torrent.seeders | number}}</td>
                                    <td class='text-right' ng-show='settings.displayNumLeechers'>{{torrent.leechers | number}}</td>
                                    <td class='text-right' ng-show='settings.displayNumDownloads'>{{torrent.downloads | number}}</td>
                                </tr>
                        </tbody>
                    </table>
                </div>
            </div>    
        </div>         
    </div>             

    <div class='container-fluid'>
        <button type='button' class='btn btn-primary btn-block btn-lg' ng-click='pullTorrents()'>More...</button>
    </div>

    <hr>

    <div class='container-fluid'>
        <div class='row'>
            <div class='col-md-4'>
                <form class='form-horizontal' role='form'>
                    <div class='form-group'>
                        <label class='control-label col-sm-3'>Order groups by</label>
                        <div class='col-sm-3'>
                            <select class='form-control' ng-model='settings.sortField'>
                                <option value='title'>Title</option>
                                <option value='seeders'>Seeders</option>
                                <option value='leechers'>Leechers</option>
                                <option value='downloads'>Downloads</option>
                            </select>
                        </div>
                        <div class='col-sm-6'>
                            <div class='checkbox'><label><input type='checkbox' ng-model='settings.sortReverse'>Descending</label></div>
                        </div>
                    </div>
                    <div class='form-group'>
                        <label class='control-label col-sm-3'>Group limit</label>
                        <div class='col-sm-3'><input ng-model='settings.groupDisplayLimit' type='text' class='form-control'></div>
                        <div class='col-sm-6'><p class='help-block'>{{strings.groupDisplayLimitHelp}}</p></div>
                    </div>
                </form>
            </div>
            <div class='col-md-4'>
                <form class='form-horizontal' role='form'>
                    <div class='form-group'>
                        <label class='control-label col-sm-3'>Display fields</label>
                        <div class='col-sm-6'>
                            <div class='checkbox'><label><input type='checkbox' ng-model='settings.displayNumSeeders'>Seeders</label></div>
                            <div class='checkbox'><label><input type='checkbox' ng-model='settings.displayNumLeechers'>Leechers</label></div>
                            <div class='checkbox'><label><input type='checkbox' ng-model='settings.displayNumDownloads'>Downloads</label></div>
                        </div>
                    </div>
                </form>
            </div>
            <div class='col-md-4'>
                &nbsp;
            </div>
        </div>
    </div>
    
</body>
</html>