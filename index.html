<!doctype html>
<html lang='en' ng-app='_app'>
<head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <script src='http://ajax.googleapis.com/ajax/libs/angularjs/1.2.18/angular.min.js'></script>
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <title>ATL</title>
</head>
<body ng-controller='_controller'>
    <script>
        var debug;
    
        var _app = angular.module('_app', []);

        _app.controller('_controller', ['$scope', '$http', function ($scope, $http) {
        
            $scope.strings = {
                displayNumGroupsPerDayHelp: 'Maximum number of groups to display in a single day.',
            };

            function CustomBooleanIn(value) { return !!value ? '1' : '0'; }
            function CustomBooleanOut(value) { return !!Number(value); }

            $scope.settings = {
                defaultValues: [
                    { name: 'orderByField', defaultValue: 'downloads', castIn: String, castOut: String },
                    { name: 'orderDescending', defaultValue: true, castIn: CustomBooleanIn, castOut: CustomBooleanOut },
                    { name: 'displayNumSeeders', defaultValue: false, castIn: CustomBooleanIn, castOut: CustomBooleanOut },
                    { name: 'displayNumLeechers', defaultValue: false, castIn: CustomBooleanIn, castOut: CustomBooleanOut },
                    { name: 'displayNumDownloads', defaultValue: true, castIn: CustomBooleanIn, castOut: CustomBooleanOut },
                    { name: 'displayNumGroupsPerDay', defaultValue: 15, castIn: String, castOut: Number },
                    { name: 'downloadDaysPerRequest', defaultValue: 2, castIn: String, castOut: Number },
                ]
            };

            for (var index = 0; index < $scope.settings.defaultValues.length; index += 1) {
                var property = $scope.settings.defaultValues[index];
                $scope.settings.__defineGetter__(property.name, (function (property) {
                    return function () {
                        if (localStorage.getItem(property.name) != null)
                            return property.castOut(localStorage.getItem(property.name));
                        else return property.defaultValue;
                    }
                })(property));
                $scope.settings.__defineSetter__(property.name, (function (property) {
                    return function (value) { localStorage.setItem(property.name, property.castIn(value)); }
                })(property));
            }

            $scope.days = [];
            var daysOffset = 0;
            
            ($scope.pullTorrents = function () {
                $http.get(['torrents?num_days=', $scope.settings.downloadDaysPerRequest, '&offset=', daysOffset].join(''))
                    .success(function (data, status, headers, config) {
                        $scope.days = $scope.days.concat(data);
                        daysOffset += 1;
                    })
                    .error(function (data, status, headers, config) {
                        console.log('Request failed.');
                        console.log(arguments);
                    });
            })();
            
        }]);
    </script>

    <style>
        td a { color: #333; }
        td a:visited { color: #999; }
        tr.small { font-size: 75%; }
        .clickableGlyph { cursor: pointer; }
    </style>

    <hr>

    <div class='container-fluid'>
        <div class='row'>
            <div class='col-md-6' ng-repeat='day in days' ng-show='filteredDay.length > 0'>
                <a name='day-{{$index}}'></a>
                <div class='panel panel-default'>
                    <div class='panel-heading'>
                        Day &minus;{{$index}}
                            <em class='pull-right'>
                                Displaying {{filteredDay.length}} of {{day.length}} groups.
                                <a ng-show='filteredDay.length < day.length' ng-click='day.limit = day.length' href='#day-{{$index}}'>Show everything?</a>
                            </em>
                    </div>
                    <table class='table table-condensed'>
                        <thead>
                            <tr>
                                <th width='1%'>&nbsp;</th>
                                <th>Groups</th>
                                <th width='10%' class='text-right' ng-show='settings.displayNumSeeders'>&Sigma;S</th>
                                <th width='10%' class='text-right' ng-show='settings.displayNumLeechers'>&Sigma;L</th>
                                <th width='10%' class='text-right' ng-show='settings.displayNumDownloads'>&Sigma;D</th>
                            </tr>
                        </thead>
                        <tbody>
                                <tr
                                    ng-repeat-start='group in filteredDay = (day | orderBy:settings.orderByField:settings.orderDescending | limitTo:(day.limit || settings.displayNumGroupsPerDay))'
                                    ng-init='filteredTorrents = (group.torrents | orderBy:settings.orderByField:settings.orderDescending)'
                                >
                                    <td>
                                        <span
                                            ng-click='group.expanded = !group.expanded'
                                            class='glyphicon glyphicon-{{ {true: "minus-sign", false: "plus-sign"}[!!group.expanded] }} clickableGlyph'>
                                        </span>
                                    </td>
                                    <td>
                                        <a href='{{filteredTorrents[0].link}}'>{{group.title}}<strong ng-show='group.episode'> Ep. {{group.episode}}</strong></a>
                                    </td>
                                    <td class='text-right' ng-show='settings.displayNumSeeders'>{{group.seeders | number}}</td>
                                    <td class='text-right' ng-show='settings.displayNumLeechers'>{{group.leechers | number}}</td>
                                    <td class='text-right' ng-show='settings.displayNumDownloads'>{{group.downloads | number}}</td>
                                </tr>
                                <tr class='small' ng-repeat-end ng-show='group.expanded' ng-repeat='torrent in filteredTorrents'>
                                    <td>&nbsp;</td>
                                    <td><a href='{{torrent.link}}'>{{torrent.title}}</a></td>
                                    <td class='text-right' ng-show='settings.displayNumSeeders'>{{torrent.seeders | number}}</td>
                                    <td class='text-right' ng-show='settings.displayNumLeechers'>{{torrent.leechers | number}}</td>
                                    <td class='text-right' ng-show='settings.displayNumDownloads'>{{torrent.downloads | number}}</td>
                                </tr>
                        </tbody>
                    </table>
                </div>
            </div>    
        </div>         
    </div>             

    <div class='container-fluid'>
        <button type='button' class='btn btn-primary btn-block btn-lg' ng-click='pullTorrents()'>More...</button>
    </div>

    <hr>

    <div class='container-fluid'>
        <div class='row'>
            <div class='col-md-4'>
                <form class='form-horizontal' role='form'>
                    <div class='form-group'>
                        <label class='control-label col-sm-3'>Order groups by</label>
                        <div class='col-sm-3'>
                            <select class='form-control' ng-model='settings.orderByField'>
                                <option value='title'>Title</option>
                                <option value='seeders'>Seeders</option>
                                <option value='leechers'>Leechers</option>
                                <option value='downloads'>Downloads</option>
                            </select>
                        </div>
                        <div class='col-sm-6'>
                            <div class='checkbox'><label><input type='checkbox' ng-model='settings.orderDescending'>Descending</label></div>
                        </div>
                    </div>
                    <div class='form-group'>
                        <label class='control-label col-sm-3'>Group limit</label>
                        <div class='col-sm-3'><input ng-model='settings.displayNumGroupsPerDay' type='text' class='form-control'></div>
                        <div class='col-sm-6'><p class='help-block'>{{strings.displayNumGroupsPerDayHelp}}</p></div>
                    </div>
                </form>
            </div>
            <div class='col-md-4'>
                <form class='form-horizontal' role='form'>
                    <div class='form-group'>
                        <label class='control-label col-sm-3'>Display fields</label>
                        <div class='col-sm-6'>
                            <div class='checkbox'><label><input type='checkbox' ng-model='settings.displayNumSeeders'>Seeders</label></div>
                            <div class='checkbox'><label><input type='checkbox' ng-model='settings.displayNumLeechers'>Leechers</label></div>
                            <div class='checkbox'><label><input type='checkbox' ng-model='settings.displayNumDownloads'>Downloads</label></div>
                        </div>
                    </div>
                </form>
            </div>
            <div class='col-md-4'>
                &nbsp;
            </div>
        </div>
    </div>
    
</body>
</html>